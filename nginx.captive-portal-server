upstream portal {
    server unix:///var/run/captive-portal/uwsgi.sock;
}

% for vlan_id in vlans:
  % if vlans[vlan_id]['captive_portal'] != None:
server {

    listen 0.0.0.0:${vlan_id + 20000};
    server_name captive-portal;

    # Disable keep-alives: once authenticated the browser may reuse the connection when going to the initial site.
    keepalive_timeout 0;

    # no need for logs
    access_log off;
    
    location / {
      uwsgi_pass portal;
      include uwsgi_params;
      uwsgi_param "vlan" "${vlans[vlan_id]['id']}"; ## id of cc agent vlan object
      uwsgi_param "vlan_id" "${vlan_id}";
      uwsgi_param "web_authentication" "${vlans[vlan_id]['web_authentication']}";
      uwsgi_param "guest_access" "${vlans[vlan_id]['guest_access']}";
      #uwsgi_param "captive_portal" "${vlans[vlan_id]['captive_portal']}";
    }
}
  % endif
% endfor