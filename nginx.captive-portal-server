upstream portal {
    server unix:///var/run/captive-portal/uwsgi.sock;
}

server {

    listen 0.0.0.0:80;
    listen [::]:80;
    server_name dashboard;

    # no need for logs
    access_log off;
    
    location /static/captive-portal {
      alias /origin/captive-portal/captive_portal/static/captive-portal;
    }
    location / {
      uwsgi_pass portal;
      include uwsgi_params;
    }
}

% for vlan_id in vlans:
server {

    listen 0.0.0.0:${vlan_id + 20000};
    listen [::]:${vlan_id + 20000};
    server_name captive-portal;

    # Disable keep-alives: once authenticated the browser may reuse the connection when going to the initial site.
    keepalive_timeout 0;

    # no need for logs
    access_log off;
    
    location /static/captive-portal {
      alias /origin/captive-portal/captive_portal/static/captive-portal;
    }
    
    location / {
      uwsgi_pass portal;
      include uwsgi_params;
      uwsgi_param "vlan" "${vlans[vlan_id]['id']}"; ## id of cc agent vlan object
      uwsgi_param "vlan_id" "${vlan_id}";
      uwsgi_param "web_authentication" "${vlans[vlan_id]['web_authentication'] or ''}";
      uwsgi_param "guest_access" "${vlans[vlan_id]['guest_access'] or ''}";
      #uwsgi_param "captive_portal" "$ {vlans[vlan_id]['captive_portal'] or ''}";
    }
}
% endfor