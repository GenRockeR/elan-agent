upstream portal {
    server unix:///var/run/captive-portal/uwsgi.sock;
}

server {

    listen 0.0.0.0:80;
    listen 0.0.0.0:443 ssl;
    listen [::]:80;
    listen [::]:443 ssl;
    server_name allowed_macs;

    ssl_certificate     /origin/network/certs/captive-portal.origin-nexus.com.crt;
    ssl_certificate_key /origin/network/certs/captive-portal.origin-nexus.com.key;

    # no need for logs
    access_log off;
    
    location /static/captive-portal {
      alias /origin/captive-portal/captive_portal/static/captive-portal;
    }
    location / {
      uwsgi_pass portal;
      include uwsgi_params;
    }
}

server {

    listen 0.0.0.0:19998;
    listen 0.0.0.0:19999 ssl;
    listen [::]:19998;
    listen [::]:19999 ssl;
    server_name dashboard;

    ssl_certificate     /origin/network/certs/edge-agent.origin-nexus.com.crt;
    ssl_certificate_key /origin/network/certs/edge-agent.origin-nexus.com.key;

    # no need for logs
    access_log off;
    
    location /static/captive-portal {
      alias /origin/captive-portal/captive_portal/static/captive-portal;
    }
    location / {
      uwsgi_pass portal;
      include uwsgi_params;
      uwsgi_param "dashboard" "1";
    }
}

% for vlan_id in vlans:
  % if vlans[vlan_id]['access_control']:

server {

    listen 0.0.0.0:${vlan_id + 20000};
    listen 0.0.0.0:${vlan_id + 25000} ssl;
    listen [::]:${vlan_id + 20000};
    listen [::]:${vlan_id + 25000} ssl;
    server_name captive-portal;

    ssl_certificate     /origin/network/certs/captive-portal.origin-nexus.com.crt;
    ssl_certificate_key /origin/network/certs/captive-portal.origin-nexus.com.key;

    # Disable keep-alives: once authenticated the browser may reuse the connection when going to the initial site.
    keepalive_timeout 0;

    # no need for logs
    access_log off;
    
    location /static/captive-portal {
      alias /origin/captive-portal/captive_portal/static/captive-portal;
    }
    
    location / {
      uwsgi_pass portal;
      include uwsgi_params;
      uwsgi_param "vlan" "${vlans[vlan_id]['id']}"; ## id of cc agent vlan object
      uwsgi_param "vlan_id" "${vlan_id}";
      uwsgi_param "web_authentication" "${vlans[vlan_id]['web_authentication'] or ''}";
      uwsgi_param "guest_access" "${vlans[vlan_id]['guest_access'] or ''}";
    }
}
  % endif
% endfor
