#!/usr/sbin/nft -f

flush table bridge origin

table bridge origin {
  chain global_ac {
  }

  chain allowed_macs  { 
  }
  
  chain input {
    type filter hook input priority -200;
    iifname != "eth0" log group 10
  }
  
  chain forward { 
    type filter hook forward priority -200;
    iifname != "eth0" log group 10
    iif eth0 accept 
    
    oif eth0 ether type 0x0806 accept

    oif eth0 jump global_ac

    oif eth0 jump allowed_macs
    
    oif eth0 iif @dhcp_pt_ifs mark 10067 accept
    oif eth0 iif @dns_pt_ifs mark 10053 accept
    
    #oif eth0 iif @dhcp_pt_ifs ip protocol udp udp sport bootpc udp dport bootps accept
    #oif eth0 iif @dhcp_pt_ifs ip6 saddr {fe80::/10} ip6 daddr ff02::1:2 ip6 nexthdr udp udp sport dhcpv6-client udp dport dhcpv6-server accept
    #oif eth0 iif @dhcp_pt_ifs ip6 nexthdr ipv6-icmp icmpv6 type nd-router-solicit accept

    #oif eth0 iif @dns_pt_ifs ip protocol udp udp dport domain accept
    #oif eth0 iif @dns_pt_ifs ip6 nexthdr udp udp dport domain accept

    oif eth0 iif @ac_ifs drop

    oif eth0 accept

    drop
  }

  chain output {
    type filter hook output priority 200;
  }

}


flush table ip origin

table ip origin {
  chain global_ac {
  }
  
  chain captive_portal  { 
  }

  chain allowed_macs  { 
  }
  
  chain prerouting  { 
    type nat hook prerouting priority -150;

    jump global_ac
    tcp dport {80, 443} jump captive_portal
  }
  
  chain postrouting { 
    type nat hook postrouting priority -150;
  } 
}


flush table ip6 origin

table ip6 origin {
  chain global_ac {
  }
  
  chain captive_portal  { 
  }

  chain allowed_macs  { 
  }
  
  chain prerouting  { 
    type nat hook prerouting priority -150;
    
    jump global_ac
    tcp dport {80, 443} jump captive_portal
  }
  
  chain postrouting { 
    type nat hook postrouting priority -150;
  } 
}
